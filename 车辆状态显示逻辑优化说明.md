# 车辆状态显示逻辑优化说明

## 修改时间
2024-12-09

## 修改内容

### 1. 使用 `venuestatus` 字段判断状态

**修改前**：通过时间字段（entertime、leavetime）判断入场和离场状态  
**修改后**：通过 `venuestatus` 字段判断状态

```javascript
// 新增：根据venuestatus字段判断车辆状态
const getVehicleStatus = (item) => {
    const venuestatus = item.venuestatus || '';
    const visitdate = item.visitdate;
    
    // 检查是否过期
    let isExpired = false;
    if (visitdate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const visitDate = new Date(visitdate);
        visitDate.setHours(0, 0, 0, 0);
        isExpired = visitDate < today;
    }
    
    // 根据venuestatus判断入场和离场状态
    const hasEntered = venuestatus === '已入场' || venuestatus === '已离场';
    const hasLeft = venuestatus === '已离场';
    
    // 已离场的不显示过期，显示离场状态
    // 未离场的才显示过期状态
    const shouldShowExpired = isExpired && !hasLeft;
    
    return {
        isExpired,
        hasEntered,
        hasLeft,
        shouldShowExpired
    };
};
```

### 2. 优化状态显示逻辑

**核心规则**：**已过期** 和 **已离场** 只显示一个

#### 显示优先级

```
已离场 > 已过期 > 有效
```

#### 具体逻辑

| venuestatus | 预约日期 | 第一个徽章 | 第二个徽章 |
|-------------|----------|------------|------------|
| 已离场 | 任意 | 🚪 已离场 | ❌ 不显示入场状态 |
| 已入场 | 已过期 | ❌ 已过期 | 🚗 已入场 |
| 已入场 | 有效 | ✅ 有效 | 🚗 已入场 |
| 未入场/其他 | 已过期 | ❌ 已过期 | 🚗 未入场 |
| 未入场/其他 | 有效 | ✅ 有效 | 🚗 未入场 |

### 3. 修复车牌颜色识别

**问题**：黑ADE45J（7位车牌）被错误识别为新能源车牌（绿色）  
**原因**：原逻辑 `plate.includes('D')` 过于宽泛

**修复方案**：
```javascript
// 修复前：只要包含D或F就识别为新能源 ❌
if (plate.includes('D') || plate.includes('F')) {
    return 'new-energy';
}

// 修复后：只检查第6位（下标5）✅
const char6 = plate.charAt(5);
if (char6 === 'D' || char6 === 'F') {
    return 'new-energy';
}
```

**示例对比**：

| 车牌号 | 修复前 | 修复后 | 说明 |
|--------|--------|--------|------|
| 黑ADE45J | 🟢 新能源 | 🔵 传统 | ✅ D在第3位，不是新能源 |
| 鲁AD1234D | 🟢 新能源 | 🟢 新能源 | ✅ 第6位是D |
| 鲁BF5678F | 🟢 新能源 | 🟢 新能源 | ✅ 第6位是F |

### 4. 处理空值和null字符串

**问题**：数据库返回 `"(Null)"` 字符串被误判为有效值

**修复**：过滤以下情况
- `null` 值
- `"null"` 字符串
- `"(Null)"` 字符串
- 空字符串

```javascript
if (!enterTime || enterTime === 'null' || enterTime === '(Null)' || enterTime.trim() === '') {
    return false;
}
```

---

## 表格显示示例

### 场景1：已离场车辆
```
徽章1：🚪 已离场
徽章2：（不显示）
停车时长：2小时30分钟
```

### 场景2：已入场且已过期
```
徽章1：❌ 已过期
徽章2：🚗 已入场
停车时长：（如果有）
```

### 场景3：已入场且有效
```
徽章1：✅ 有效
徽章2：🚗 已入场
停车时长：（如果有）
```

### 场景4：未入场且已过期
```
徽章1：❌ 已过期
徽章2：🚗 未入场
停车时长：（无）
```

### 场景5：未入场且有效
```
徽章1：✅ 有效
徽章2：🚗 未入场
停车时长：（无）
```

---

## 详情弹窗显示

### 已离场时
```
状态：已离场
停车时长：X小时X分钟（如果有）
```

### 未离场时
```
预约状态：已过期 / 有效
入场状态：已入场 / 未入场
停车时长：X小时X分钟（如果有）
```

---

## 技术要点

1. ✅ **单一数据源**：使用 `venuestatus` 作为入场/离场状态的唯一判断依据
2. ✅ **状态互斥**：已离场和已过期不会同时显示
3. ✅ **条件渲染**：已离场时不显示入场状态
4. ✅ **空值处理**：正确处理 null、"(Null)" 等特殊字符串
5. ✅ **车牌识别**：准确识别新能源车牌（第6位为D或F）

---

## 相关文件

- `src/views/admin/Appointment.vue` - 预约管理页面

---

**修改完成！** 🎉
