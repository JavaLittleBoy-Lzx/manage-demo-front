# 黑名单数据清理功能使用说明

## 功能概述

数据清理功能是基于外部API查询结果的智能清理功能，用于保持本地黑名单数据与外部系统的一致性，清理本地多余的数据。

## 功能特点

### 🎯 核心功能
- **智能对比**：自动对比本地黑名单与外部API数据
- **精准清理**：清理本地存在但外部API中不存在的多余记录
- **关联清理**：同时清理对应的违规记录
- **安全操作**：使用逻辑删除，支持数据恢复

### 🔍 工作原理

1. **数据查询**
   - 查询本地黑名单记录
   - 调用外部API获取最新黑名单数据

2. **数据对比**
   - 构建外部API车牌号集合
   - 找出本地有但外部API没有的多余记录

3. **执行清理**
   - 清理违规记录（物理删除）
   - 清理黑名单记录（逻辑删除）
   - 记录操作日志

## 使用方法

### 前端操作

1. **进入黑名单管理页面**
   - 选择要清理的车场
   - 点击"清理多余数据"按钮

2. **确认操作**
   - 系统会显示操作说明
   - 确认后开始执行数据对比和清理

3. **查看结果**
   - 显示清理统计信息
   - 列出已清理的车牌号

### API接口

```http
GET /parking/blackList/autoDeleteByExternalApi?parkName={车场名称}
```

**参数说明：**
- `parkName`: 车场名称（万象上东、四季上东、欧洲新城）

**返回结果：**
```json
{
  "code": "0",
  "msg": "数据清理完成！清理了 X 条多余的黑名单记录和 Y 条违规记录",
  "data": {
    "parkName": "万象上东",
    "localRecordCount": 100,
    "externalRecordCount": 95,
    "deletedBlackListCount": 5,
    "deletedViolationCount": 12,
    "deletedCars": ["黑A12345", "黑B67890"]
  }
}
```

## 车场支持

| 车场名称 | 车场代码 | 支持状态 |
|---------|---------|---------|
| 万象上东 | 2KST9MNP | ✅ 支持 |
| 四季上东 | 2KUG6XLU | ✅ 支持 |
| 欧洲新城 | 2KPL6XFF | ✅ 支持 |

## 安全特性

### 🛡️ 数据安全
- **逻辑删除**：黑名单记录使用逻辑删除，可恢复
- **操作日志**：记录所有清理操作，便于审计
- **错误处理**：完善的异常处理机制

### 🔒 权限控制
- **角色限制**：欧洲新城用户只能清理欧洲新城数据
- **确认机制**：操作前需要用户确认
- **操作记录**：记录操作用户和时间

## 使用场景

### 📋 适用场景
1. **数据同步**：定期清理过期或无效的黑名单记录
2. **数据维护**：清理因外部系统变更导致的冗余数据
3. **系统升级**：升级后清理不一致的数据

### ⚠️ 注意事项
1. **操作不可逆**：清理的违规记录无法恢复
2. **网络依赖**：需要外部API正常响应
3. **批量操作**：建议在业务低峰期执行

## 监控与日志

### 📊 操作监控
- 控制台输出详细的操作日志
- 前端显示操作进度和结果
- 数据库记录操作历史

### 📝 日志内容
- 操作开始和结束时间
- 数据统计信息
- 清理的车牌号列表
- 错误信息和异常处理

## 故障排除

### 常见问题

1. **外部API无响应**
   - 检查网络连接
   - 验证API地址和参数
   - 查看服务器日志

2. **清理失败**
   - 检查数据库连接
   - 验证用户权限
   - 查看错误日志

3. **数据不一致**
   - 重新执行同步操作
   - 检查外部API数据
   - 联系技术支持

### 技术支持
如遇到问题，请联系技术支持并提供：
- 操作时间
- 车场名称
- 错误信息
- 相关日志

---

**版本**: v1.0  
**更新时间**: 2024年12月  
**维护团队**: 停车管理系统开发组
