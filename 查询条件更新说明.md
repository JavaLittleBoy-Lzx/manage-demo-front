# 查询条件更新说明 - 从 userId 改为 username

## 更新日期
2025年10月31日

## 更新内容

### 问题描述
之前的实现使用 `userId` 来查询操作历史和通知，但实际需求是根据 `username`（用户名）来查询。

### 解决方案

已将所有查询条件从 `userId` 改为 `username`：

---

## 1. 个人中心 - 操作历史查询 ✅

### 修改文件
`src/views/admin/ProfileCenter.vue`

### 修改内容

**之前（使用 userId）：**
```javascript
const userId = localStorage.getItem('ms_userid') || localStorage.getItem('userId');
const params = {
  pageNum: historyPageNum.value,
  pageSize: historyPageSize.value,
  userId: userId // 使用 userId
};
```

**现在（使用 username）：**
```javascript
const username = localStorage.getItem('ms_username');
const params = {
  pageNum: historyPageNum.value,
  pageSize: historyPageSize.value,
  username: username // 使用 username
};
```

### API 请求示例
```
GET /parking/activity-log/page?pageNum=1&pageSize=10&username=东北林业大学_管理员001
```

---

## 2. 通知铃铛 - 操作日志查询 ✅

### 修改文件
`src/components/Header.vue`

### 修改内容

**之前（使用 userId）：**
```javascript
if (!currentUserId.value) {
  await loadCurrentUser();
}

const response = await activityApi.getActivityLogPage({
  pageNum: 1,
  pageSize: 1000,
  userId: currentUserId.value
});
```

**现在（使用 username）：**
```javascript
const username = localStorage.getItem('ms_username');

if (!username) {
  console.warn('Header: 未找到用户名，无法加载通知');
  return;
}

const response = await activityApi.getActivityLogPage({
  pageNum: 1,
  pageSize: 1000,
  username: username
});
```

### API 请求示例
```
GET /parking/activity-log/page?pageNum=1&pageSize=1000&username=东北林业大学_管理员001
```

---

## 3. 用户统计信息查询 ✅

### 修改文件
`src/views/admin/ProfileCenter.vue`

### 修改内容

**操作次数统计：**
```javascript
// 根据用户名查询操作历史总数
const allLogsResponse = await activityApi.getActivityLogPage({
  pageNum: 1,
  pageSize: 1000,
  username: username
});

userInfo.value.loginCount = allLogsResponse.data.data.total || 0;
```

**最后登录时间：**
```javascript
// 根据用户名查询最后登录记录
const lastLoginResponse = await activityApi.getActivityLogPage({
  pageNum: 1,
  pageSize: 1,
  username: username,
  action: '登录'
});
```

---

## 后端 API 要求

### activity-log 查询接口

**接口地址：**
```
GET /parking/activity-log/page
```

**请求参数：**
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "username": "东北林业大学_管理员001"  // ⚠️ 必需，根据用户名过滤
}
```

**响应格式：**
```json
{
  "code": "0",
  "message": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "username": "东北林业大学_管理员001",
        "userId": "1",
        "action": "用户登录",
        "module": "用户认证",
        "description": "用户登录操作",
        "ipAddress": "0:0:0:0:0:0:0:1",
        "createdAt": "2025-10-31T08:46:00"
      }
    ],
    "total": 4
  }
}
```

---

## 数据库查询说明

### 查询逻辑
后端应该根据 `username` 字段进行过滤：

```sql
SELECT * FROM activity_log 
WHERE username = '东北林业大学_管理员001'
ORDER BY created_at DESC
LIMIT 10 OFFSET 0;
```

### 字段说明
- `username`: 用户名（如：东北林业大学_管理员001）
- `userId`: 用户ID（如：1）
- 两者都会返回，但查询条件使用 `username`

---

## 调试日志

### 个人中心日志
```
ProfileCenter: 加载操作历史，username: 东北林业大学_管理员001
ProfileCenter: 查询参数: {pageNum: 1, pageSize: 10, username: "东北林业大学_管理员001"}
ProfileCenter: 查询条件 - username: 东北林业大学_管理员001
ProfileCenter: 操作历史记录数量: 4
```

### 通知铃铛日志
```
Header: 加载通知，username: 东北林业大学_管理员001
Header: 操作历史记录数量: 4
```

### 统计信息日志
```
ProfileCenter: 开始加载用户统计信息, username: 东北林业大学_管理员001
ProfileCenter: 操作次数: 4
ProfileCenter: 最后登录时间: 2025-10-31T08:46:00
```

---

## 验证步骤

### 1. 验证个人中心操作历史
1. 登录系统（如：东北林业大学_管理员001）
2. 进入个人中心
3. 切换到"操作历史"标签
4. 打开浏览器控制台（F12）
5. 查看请求参数是否包含 `username=东北林业大学_管理员001`
6. 确认返回的记录都是当前用户的操作

### 2. 验证通知铃铛
1. 登录系统
2. 查看右上角通知铃铛
3. 点击铃铛图标
4. 打开控制台查看请求
5. 确认请求参数包含 `username=东北林业大学_管理员001`
6. 确认通知内容都是当前用户的操作

### 3. 验证多用户隔离
1. 使用用户A登录，执行一些操作
2. 退出，使用用户B登录
3. 查看操作历史，应该只看到用户B的操作
4. 查看通知，应该只看到用户B的通知

---

## 优势说明

### 使用 username 的优势
1. ✅ **更直观**：用户名比用户ID更具可读性
2. ✅ **无需转换**：不需要从username查询userId
3. ✅ **统一标准**：后端activity_log表主要使用username
4. ✅ **便于调试**：日志中直接显示用户名，更容易排查问题

### 数据隔离
- 每个用户只能看到自己的操作历史
- 通知铃铛只显示当前用户的操作
- 统计数据只统计当前用户的记录

---

## 注意事项

### 1. 用户名唯一性
- 确保数据库中 `username` 字段是唯一的
- 避免多个用户使用相同的用户名

### 2. 用户名格式
- 当前格式：`停车场名称_角色名称编号`
- 示例：`东北林业大学_管理员001`

### 3. localStorage 依赖
- 代码依赖 `localStorage.getItem('ms_username')`
- 登录时必须正确设置该值

### 4. 后端兼容性
- 后端接口需要支持 `username` 参数
- 如果后端只支持 `userId`，需要后端修改

---

## 测试用例

### 测试用例1：单用户操作历史
```
操作：用户A登录并执行多个操作
预期：个人中心显示所有用户A的操作记录
验证：查询参数包含 username=用户A
```

### 测试用例2：多用户隔离
```
操作：
1. 用户A登录，执行操作1、操作2
2. 用户B登录，执行操作3、操作4
预期：
- 用户A只看到操作1、操作2
- 用户B只看到操作3、操作4
```

### 测试用例3：通知铃铛
```
操作：用户A登录，点击通知铃铛
预期：
- 只显示用户A的操作记录
- 请求参数包含 username=用户A
```

### 测试用例4：日期筛选
```
操作：
1. 用户A在不同日期执行多个操作
2. 在个人中心选择日期范围
预期：
- 只显示选定日期范围内的记录
- 所有记录都是用户A的
- 请求参数包含 username=用户A 和日期范围
```

---

## 总结

### 修改的文件
1. ✅ `src/views/admin/ProfileCenter.vue`
   - 操作历史查询
   - 用户统计信息

2. ✅ `src/components/Header.vue`
   - 通知铃铛查询

### 修改的查询参数
- **修改前**：`userId: "1"`
- **修改后**：`username: "东北林业大学_管理员001"`

### 影响范围
- 个人中心操作历史
- 右上角通知铃铛
- 登录次数统计
- 最后登录时间

---

## 版本信息
- 版本：v1.4.0
- 更新日期：2025-10-31
- 开发者：AI Assistant
- 更新内容：查询条件从 userId 改为 username

