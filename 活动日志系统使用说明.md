# 活动日志系统使用说明

## 功能概述

活动日志系统已成功集成到停车管理系统中，用于记录和显示系统中的各种重要活动。系统现在支持：

1. **真实数据显示** - 首页"最近活动"模块现在使用真实的API数据
2. **自动日志记录** - 系统操作会自动记录相关活动
3. **统一日志接口** - 提供标准化的日志记录工具

## 主要文件

### 1. API接口 (`src/api/activity.js`)
包含所有活动相关的API接口：
- `getRecentActivities()` - 获取最近活动列表
- `logOwnerRegistration()` - 记录业主注册活动
- `logViolationRecord()` - 记录违规活动
- `logAppointmentApproval()` - 记录预约审批活动
- `logMonthTicketRenewal()` - 记录月票续费活动
- 等等...

### 2. 日志工具 (`src/utils/activityLogger.js`)
统一的活动记录工具，支持：
- 业主注册记录
- 违规记录
- 预约审批记录
- 月票续费记录
- 车辆进出记录
- 系统操作记录

### 3. 首页组件 (`src/views/admin/EmptyPer.vue`)
已更新为使用真实数据：
- 动态获取活动数据
- 实时显示相对时间
- 支持手动刷新
- 加载状态显示
- 空状态处理

## 使用方法

### 在其他页面中记录活动

```javascript
// 导入日志工具
import activityLogger from '@/utils/activityLogger';

// 记录业主注册
await activityLogger.logOwnerRegistration({
  ownerId: '12345',
  ownerName: '张三',
  plateNumber: '京A12345',
  communityId: 'community_001'
});

// 记录违规记录
await activityLogger.logViolationRecord({
  violationId: 'v_001',
  plateNumber: '沪B67890',
  location: '东门停车场',
  violationType: '违规停车'
});

// 记录预约审批
await activityLogger.logAppointmentApproval({
  appointmentId: 'app_001',
  applicantName: '李四',
  visitorName: '王五',
  status: 'APPROVED',
  approver: '管理员'
});
```

### 在业务流程中集成日志

#### 1. 业主注册流程
在 `OwnerInfo.vue` 或相关组件的保存方法中：

```javascript
async saveOwner() {
  try {
    // 保存业主信息
    const response = await ownerApi.save(this.ownerForm);
    
    // 记录活动日志
    await activityLogger.logOwnerRegistration({
      ownerId: response.data.id,
      ownerName: this.ownerForm.name,
      plateNumber: this.ownerForm.plateNumber,
      communityId: this.ownerForm.communityId
    });
    
    this.$message.success('业主信息保存成功');
  } catch (error) {
    console.error('保存失败:', error);
  }
}
```

#### 2. 违规记录流程
在 `IllegalRegiste.vue` 或相关组件中：

```javascript
async addViolation() {
  try {
    // 添加违规记录
    const response = await violationApi.add(this.violationForm);
    
    // 记录活动日志
    await activityLogger.logViolationRecord({
      violationId: response.data.id,
      plateNumber: this.violationForm.plateNumber,
      location: this.violationForm.location,
      violationType: this.violationForm.type
    });
    
    this.$message.success('违规记录添加成功');
  } catch (error) {
    console.error('添加失败:', error);
  }
}
```

#### 3. 预约审批流程
在 `AppointAudit.vue` 或相关组件中：

```javascript
async approveAppointment(appointmentId, status) {
  try {
    // 审批预约
    const response = await appointmentApi.approve(appointmentId, status);
    
    // 记录活动日志
    await activityLogger.logAppointmentApproval({
      appointmentId: appointmentId,
      applicantName: response.data.applicantName,
      visitorName: response.data.visitorName,
      status: status,
      approver: this.currentUser.name
    });
    
    this.$message.success('审批操作完成');
  } catch (error) {
    console.error('审批失败:', error);
  }
}
```

## 后端接口规范

后端需要实现以下API接口：

### 1. 获取最近活动
```
GET /parking/activities/recent?limit=10
Response: {
  "code": 200,
  "data": [
    {
      "id": 1,
      "type": "OWNER_REGISTRATION",
      "title": "新业主注册",
      "description": "张三 已完成注册并绑定车牌号 京A12345",
      "createdTime": "2024-09-11T10:30:00",
      "metadata": {
        "ownerId": "12345",
        "ownerName": "张三",
        "plateNumber": "京A12345"
      }
    }
  ]
}
```

### 2. 记录活动日志
```
POST /parking/activities/log/{activityType}
Request Body: {
  "type": "OWNER_REGISTRATION",
  "title": "新业主注册",
  "description": "张三 已完成注册并绑定车牌号 京A12345",
  "metadata": {
    "ownerId": "12345",
    "ownerName": "张三",
    "plateNumber": "京A12345"
  }
}
```

## 活动类型说明

| 类型 | 说明 | 图标 | 样式 |
|-----|------|------|------|
| OWNER_REGISTRATION | 业主注册 | User | success (绿色) |
| VIOLATION_RECORD | 违规记录 | Warning | warning (橙色) |
| APPOINTMENT_APPROVAL | 预约审批 | Check | info (蓝色) |
| MONTH_TICKET_RENEWAL | 月票续费 | Tickets | success (绿色) |
| VEHICLE_ENTRY | 车辆入场 | ArrowRight | info (蓝色) |
| VEHICLE_EXIT | 车辆出场 | ArrowRight | info (蓝色) |
| SYSTEM_OPERATION | 系统操作 | Setting | neutral (灰色) |

## 功能特性

### 1. 首页活动显示
- ✅ 实时数据获取
- ✅ 相对时间显示 (如："5分钟前"、"1小时前")
- ✅ 加载状态指示
- ✅ 手动刷新功能
- ✅ 空数据状态处理
- ✅ 错误处理和fallback数据

### 2. 日志记录功能
- ✅ 统一的日志接口
- ✅ 异步记录，不影响业务流程
- ✅ 错误处理，记录失败不影响主要功能
- ✅ 可配置开关，支持启用/禁用
- ✅ 详细的元数据记录

### 3. 用户体验
- ✅ 美观的UI界面
- ✅ 响应式设计
- ✅ 图标和颜色区分不同活动类型
- ✅ 平滑的加载动画

## 测试和验证

### 1. 前端测试
1. 访问管理后台首页，查看"最近活动"模块
2. 点击"刷新"按钮，验证数据更新
3. 检查控制台，观察API调用和数据处理日志

### 2. 日志记录测试
1. 在系统中执行业务操作（如注册业主、添加违规记录等）
2. 观察控制台日志，确认活动记录API被正确调用
3. 刷新首页，确认新的活动出现在活动列表中

### 3. 错误处理测试
1. 断开网络连接，测试离线状态下的用户体验
2. 返回模拟数据，确保系统正常运行
3. 恢复网络，验证数据刷新功能

## 注意事项

1. **API依赖** - 如果后端API未就绪，系统会自动切换到模拟数据
2. **性能考虑** - 活动记录是异步操作，不会影响主要业务流程的性能
3. **数据隐私** - 请确保敏感信息不被记录在活动日志中
4. **存储容量** - 建议定期清理旧的活动日志，避免数据库容量问题

## 未来扩展

可以考虑添加的功能：
- 活动日志的详细查看页面
- 活动日志的筛选和搜索功能
- 活动日志的导出功能
- 实时通知和推送
- 活动统计和分析报表 