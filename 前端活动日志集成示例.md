# 前端活动日志集成示例

## 1. 文件说明

### 已修改的文件
- `src/api/activity.js` - 活动日志API接口
- `src/views/admin/EmptyPer.vue` - 主页面，显示最近活动
- `src/utils/activityLogger.js` - 活动日志记录工具

## 2. 使用方法

### 2.1 在Vue组件中导入工具

```javascript
import { logActivity } from '@/utils/activityLogger';
```

### 2.2 车主管理模块集成示例

在 `src/views/admin/OwnerInfo.vue` 中添加日志记录：

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    // 添加车主
    async handleAdd() {
      try {
        const newOwner = {
          ownername: this.form.ownername,
          phonenumber: this.form.phonenumber,
          carnumber: this.form.carnumber
          // ...其他字段
        };
        
        // 执行添加操作
        const result = await ownerApi.addOwner(newOwner);
        
        if (result.code === 200) {
          // 记录成功日志
          await logActivity.ownerAdd(
            `添加车主：${newOwner.ownername}，车牌：${newOwner.carnumber}`,
            result.data.id,
            newOwner
          );
          
          this.$message.success('添加成功');
          this.getTableData();
          this.editVisible = false;
        }
      } catch (error) {
        // 记录错误日志
        await logActivity.ownerError(
          '添加',
          `添加车主失败：${this.form.ownername}`,
          error.message
        );
        
        this.$message.error('添加失败：' + error.message);
      }
    },

    // 修改车主
    async handleEdit() {
      try {
        const oldData = { ...this.currentRow }; // 保存修改前的数据
        const newData = { ...this.form };
        
        // 执行修改操作
        const result = await ownerApi.updateOwner(newData);
        
        if (result.code === 200) {
          // 记录成功日志
          await logActivity.ownerUpdate(
            `修改车主信息：${newData.ownername}`,
            newData.id,
            oldData,
            newData
          );
          
          this.$message.success('修改成功');
          this.getTableData();
          this.editVisible = false;
        }
      } catch (error) {
        await logActivity.ownerError(
          '修改',
          `修改车主信息失败：${this.form.ownername}`,
          error.message,
          this.form.id
        );
        
        this.$message.error('修改失败：' + error.message);
      }
    },

    // 删除车主
    async handleDelete(row) {
      try {
        await this.$confirm('确定要删除该车主吗？', '提示', {
          type: 'warning'
        });
        
        const result = await ownerApi.deleteOwner(row.id);
        
        if (result.code === 200) {
          // 记录删除日志
          await logActivity.ownerDelete(
            `删除车主：${row.ownername}，车牌：${row.carnumber}`,
            row.id,
            row
          );
          
          this.$message.success('删除成功');
          this.getTableData();
        }
      } catch (error) {
        if (error !== 'cancel') {
          await logActivity.ownerError(
            '删除',
            `删除车主失败：${row.ownername}`,
            error.message,
            row.id
          );
          
          this.$message.error('删除失败：' + error.message);
        }
      }
    }
  }
}
</script>
```

### 2.3 预约管理模块集成示例

在预约管理页面中：

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    // 创建预约
    async createAppointment() {
      try {
        const appointmentData = { ...this.form };
        const result = await appointmentApi.create(appointmentData);
        
        if (result.code === 200) {
          await logActivity.appointmentCreate(
            `创建预约：访客 ${appointmentData.visitorName} 预约访问`,
            result.data.id,
            appointmentData
          );
          
          this.$message.success('预约创建成功');
        }
      } catch (error) {
        await logActivity.appointmentError(
          '添加',
          '创建预约失败',
          error.message
        );
        
        this.$message.error('创建预约失败');
      }
    },

    // 审批预约
    async approveAppointment(row, status) {
      try {
        const oldData = { ...row };
        const result = await appointmentApi.approve(row.id, status);
        
        if (result.code === 200) {
          const newData = { ...row, status };
          await logActivity.appointmentApprove(
            `${status === 'APPROVED' ? '通过' : '驳回'}预约：${row.visitorName}`,
            row.id,
            oldData,
            newData
          );
          
          this.$message.success(`预约已${status === 'APPROVED' ? '通过' : '驳回'}`);
          this.getTableData();
        }
      } catch (error) {
        await logActivity.appointmentError(
          '审批',
          `审批预约失败：${row.visitorName}`,
          error.message,
          row.id
        );
        
        this.$message.error('审批失败');
      }
    }
  }
}
</script>
```

### 2.4 违规管理模块集成示例

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    // 添加违规记录
    async addViolation() {
      try {
        const violationData = { ...this.form };
        const result = await violationApi.add(violationData);
        
        if (result.code === 200) {
          await logActivity.violationAdd(
            `记录违规：车牌 ${violationData.plateNumber} 在 ${violationData.location} 违规停车`,
            result.data.id,
            violationData
          );
          
          this.$message.success('违规记录添加成功');
        }
      } catch (error) {
        await logActivity.violationError(
          '添加',
          '添加违规记录失败',
          error.message
        );
      }
    },

    // 处理违规记录
    async handleViolation(row, action) {
      try {
        const oldData = { ...row };
        const result = await violationApi.handle(row.id, action);
        
        if (result.code === 200) {
          const newData = { ...row, status: action };
          await logActivity.violationHandle(
            `处理违规记录：车牌 ${row.plateNumber}，处理结果：${action}`,
            row.id,
            oldData,
            newData
          );
          
          this.$message.success('处理成功');
          this.getTableData();
        }
      } catch (error) {
        await logActivity.violationError(
          '处理',
          `处理违规记录失败：${row.plateNumber}`,
          error.message,
          row.id
        );
      }
    }
  }
}
</script>
```

### 2.5 月票管理模块集成示例

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    // 创建月票
    async createMonthTicket() {
      try {
        const ticketData = { ...this.form };
        const result = await monthTicketApi.create(ticketData);
        
        if (result.code === 200) {
          await logActivity.monthTicketCreate(
            `创建月票：${ticketData.ownerName}，车牌：${ticketData.plateNumber}`,
            result.data.id,
            ticketData
          );
          
          this.$message.success('月票创建成功');
        }
      } catch (error) {
        await logActivity.monthTicketError(
          '添加',
          '创建月票失败',
          error.message
        );
      }
    },

    // 续费月票
    async renewMonthTicket(row) {
      try {
        const oldData = { ...row };
        const result = await monthTicketApi.renew(row.id);
        
        if (result.code === 200) {
          const newData = { ...row, expiryDate: result.data.expiryDate };
          await logActivity.monthTicketRenew(
            `月票续费：${row.ownerName}，新到期时间：${newData.expiryDate}`,
            row.id,
            oldData,
            newData
          );
          
          this.$message.success('续费成功');
          this.getTableData();
        }
      } catch (error) {
        await logActivity.monthTicketError(
          '续费',
          `月票续费失败：${row.ownerName}`,
          error.message,
          row.id
        );
      }
    }
  }
}
</script>
```

### 2.6 黑名单管理模块集成示例

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    // 添加到黑名单
    async addToBlacklist() {
      try {
        const blacklistData = { ...this.form };
        const result = await blacklistApi.add(blacklistData);
        
        if (result.code === 200) {
          await logActivity.blacklistAdd(
            `添加黑名单：车牌 ${blacklistData.plateNumber}，原因：${blacklistData.reason}`,
            result.data.id,
            blacklistData
          );
          
          this.$message.success('已添加到黑名单');
        }
      } catch (error) {
        await logActivity.blacklistError(
          '添加',
          '添加黑名单失败',
          error.message
        );
      }
    },

    // 从黑名单移除
    async removeFromBlacklist(row) {
      try {
        await this.$confirm('确定要从黑名单中移除该车辆吗？', '提示');
        
        const result = await blacklistApi.remove(row.id);
        
        if (result.code === 200) {
          await logActivity.blacklistRemove(
            `移除黑名单：车牌 ${row.plateNumber}`,
            row.id,
            row
          );
          
          this.$message.success('已从黑名单移除');
          this.getTableData();
        }
      } catch (error) {
        if (error !== 'cancel') {
          await logActivity.blacklistError(
            '移除',
            `移除黑名单失败：${row.plateNumber}`,
            error.message,
            row.id
          );
        }
      }
    }
  }
}
</script>
```

## 3. 登录登出日志记录

在登录页面和主页面中记录用户登录登出：

### 3.1 登录页面 (Login.vue)

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    async submitForm() {
      try {
        // 执行登录逻辑
        const result = await loginApi.login(this.ruleForm);
        
        if (result.code === 200) {
          // 存储用户信息
          localStorage.setItem('ms_username', result.data.username);
          localStorage.setItem('ms_userid', result.data.userId);
          
          // 记录登录日志
          await logActivity.userLogin(`用户登录：${result.data.username}`);
          
          this.$router.push('/admin');
        }
      } catch (error) {
        await logActivity.userError(
          '登录',
          `登录失败：${this.ruleForm.username}`,
          error.message
        );
      }
    }
  }
}
</script>
```

### 3.2 主页面导航栏登出

```javascript
<script>
import { logActivity } from '@/utils/activityLogger';

export default {
  methods: {
    async logout() {
      try {
        const username = localStorage.getItem('ms_username');
        
        // 记录登出日志
        await logActivity.userLogout(`用户登出：${username}`);
        
        // 清除本地存储
        localStorage.removeItem('ms_username');
        localStorage.removeItem('ms_userid');
        localStorage.removeItem('token');
        
        this.$router.push('/login');
      } catch (error) {
        console.error('登出日志记录失败:', error);
        // 即使日志记录失败也要继续登出流程
        this.$router.push('/login');
      }
    }
  }
}
</script>
```

## 4. 注意事项

1. **异步处理**：所有日志记录都是异步的，不会阻塞主要业务流程
2. **错误处理**：日志记录失败不应影响主要业务功能
3. **用户信息**：确保 `localStorage` 中存储了正确的用户ID和用户名
4. **数据格式**：传入的数据会自动转换为JSON字符串存储
5. **性能考虑**：避免在循环中频繁调用日志记录方法

## 5. 调试和测试

可以在浏览器控制台中查看日志记录的调用情况：

```javascript
// 在组件中添加调试信息
console.log('准备记录日志:', { module: '车主管理', action: '添加' });
await logActivity.ownerAdd(description, ownerId, newData);
console.log('日志记录完成');
``` 