# 自动拉黑功能测试指南

## 📋 测试目的

验证自动拉黑功能是否正常工作，包括：
1. 违规记录创建后自动检查违规次数
2. 达到阈值时自动拉黑
3. 前端页面正确显示违规次数徽章
4. 自动拉黑后所有未处理违规记录被标记为已处理

---

## 🔧 测试前准备

### 1. 配置违规次数阈值

1. 打开管理后台：`manage-front/src/views/admin/IllegalRegiste.vue`
2. 点击页面右上角的"⚙️ 月票车配置"按钮
3. 设置"累计次数"为 **3次**（方便测试）
4. 点击"保存配置"

**配置参数：**
```
- 超时时间：60分钟
- 累计次数：3次（测试用）
- 过夜时间：4小时
```

### 2. 准备测试车牌

选择一个测试车牌，例如：`黑A12345`

确保该车牌：
- 当前未被拉黑
- 违规记录少于3次（或清空该车牌的所有未处理违规记录）

---

## 🧪 测试步骤

### 测试场景1：正常违规记录添加（未达阈值）

**步骤：**

1. 打开小程序/Web端添加违规记录页面
2. 输入车牌号：`黑A12345`
3. 选择违规类型：`超时停车`
4. 填写违规位置：`A区-15号车位`
5. 添加违规描述：`超时停车1小时`
6. 点击"提交"

**预期结果：**

✅ 提交成功，显示"违规记录已成功提交"  
✅ 后端日志显示：
```
[自动拉黑检查] 开始检查车牌: 黑A12345, parkCode: 2KPL6XFF
[违规统计] 车牌 黑A12345 当前未处理违规次数: 1
[未达阈值] 车牌 黑A12345 违规次数 1 未达到阈值 3，暂不拉黑
```

✅ 该车牌不会被拉黑  
✅ 该车牌的违规记录状态仍为"未处理"（pending）

---

### 测试场景2：第二次违规（接近阈值）

**步骤：**

1. 再次添加同一车牌的违规记录
2. 车牌号：`黑A12345`
3. 违规类型：`占用消防通道`
4. 违规位置：`B区消防通道`
5. 点击"提交"

**预期结果：**

✅ 提交成功  
✅ 后端日志显示：
```
[自动拉黑检查] 开始检查车牌: 黑A12345, parkCode: 2KPL6XFF
[违规统计] 车牌 黑A12345 当前未处理违规次数: 2
[未达阈值] 车牌 黑A12345 违规次数 2 未达到阈值 3，暂不拉黑
```

✅ 在违规记录查询页面（IllegalRegiste.vue）：
- 该车牌显示 **橙色徽章** "2"
- 显示警告提示："再违规1次将自动拉黑"

![预期效果](https://via.placeholder.com/600x100/fff7e6/b45309?text=⚠️+黑A12345+🟠2+再违规1次将自动拉黑)

---

### 测试场景3：第三次违规（触发自动拉黑）⭐

**步骤：**

1. 第三次添加同一车牌的违规记录
2. 车牌号：`黑A12345`
3. 违规类型：`违规停车`
4. 违规位置：`C区-20号车位`
5. 点击"提交"

**预期结果：**

✅ 提交成功  
✅ 后端日志显示：
```
[自动拉黑检查] 开始检查车牌: 黑A12345, parkCode: 2KPL6XFF
[违规统计] 车牌 黑A12345 当前未处理违规次数: 3
[触发拉黑] 车牌 黑A12345 违规次数 3 已达到阈值 3，开始执行自动拉黑
[黑名单添加] 车牌 黑A12345 已添加到黑名单
[批量标记] 车牌 黑A12345 的 3 条违规记录已标记为已处理
[自动拉黑] 车牌 黑A12345 已达到违规次数阈值，已自动拉黑
```

✅ 在违规记录查询页面：
- 该车牌的所有3条违规记录状态变为 **"已处理"**
- 处理方式显示为 **"系统自动拉黑"**（processType: `auto_blacklist`）
- 处理人显示为 **"SYSTEM"**
- 处理备注：**"累计违规3次，系统自动拉黑"**

✅ 在黑名单页面：
- 该车牌出现在黑名单中
- 黑名单原因：**"累计违规3次，系统自动拉黑"**

---

### 测试场景4：自动拉黑后再次违规

**步骤：**

1. 第四次添加同一车牌的违规记录
2. 车牌号：`黑A12345`
3. 违规类型：`超时停车`
4. 点击"提交"

**预期结果：**

✅ 提交成功  
✅ 后端日志显示：
```
[自动拉黑检查] 开始检查车牌: 黑A12345, parkCode: 2KPL6XFF
[违规统计] 车牌 黑A12345 当前未处理违规次数: 1
[未达阈值] 车牌 黑A12345 违规次数 1 未达到阈值 3，暂不拉黑
```

✅ 该车牌仍在黑名单中（不会被重复拉黑）  
✅ 新的违规记录正常创建，状态为"未处理"

---

## 🎨 前端显示效果验证

### IllegalRegiste.vue 表格显示

打开违规记录查询页面，检查以下显示：

#### 1. 违规次数徽章

**正常状态（0-1次）：** 不显示徽章
```
黑A12345
张三
```

**警告状态（接近阈值，2次）：** 显示橙色徽章
```
黑A12345  🟠 2
张三
⚠️ 再违规1次将自动拉黑
```

**危险状态（达到阈值，3次）：** 显示红色徽章
```
黑A12345  🔴 3
张三
⚠️ 再违规0次将自动拉黑
```

#### 2. 处理状态列

自动拉黑的记录应显示：
```
状态：已处理
处理方式：系统自动拉黑
处理人：SYSTEM
处理时间：2025-10-06 14:30:00
处理备注：累计违规3次，系统自动拉黑
```

---

## 📊 数据库验证

### 1. 违规记录表（violations）

```sql
SELECT 
    id,
    plate_number,
    violation_type,
    process_status,
    process_type,
    processed_by,
    process_remark,
    created_at,
    processed_at
FROM violations
WHERE plate_number = '黑A12345'
ORDER BY created_at DESC;
```

**预期结果：**

| id | plate_number | violation_type | process_status | process_type | processed_by | process_remark | created_at | processed_at |
|----|--------------|----------------|----------------|--------------|--------------|----------------|------------|--------------|
| 103 | 黑A12345 | 超时停车 | pending | NULL | NULL | NULL | 2025-10-06 14:35:00 | NULL |
| 102 | 黑A12345 | 违规停车 | processed | auto_blacklist | SYSTEM | 累计违规3次，系统自动拉黑 | 2025-10-06 14:30:00 | 2025-10-06 14:30:00 |
| 101 | 黑A12345 | 占用消防通道 | processed | auto_blacklist | SYSTEM | 累计违规3次，系统自动拉黑 | 2025-10-06 14:25:00 | 2025-10-06 14:30:00 |
| 100 | 黑A12345 | 超时停车 | processed | auto_blacklist | SYSTEM | 累计违规3次，系统自动拉黑 | 2025-10-06 14:20:00 | 2025-10-06 14:30:00 |

### 2. 黑名单表（black_list）

```sql
SELECT 
    id,
    car_code,
    owner,
    reason,
    park_name,
    special_car_type_config_name,
    black_list_forever_flag,
    created_at
FROM black_list
WHERE car_code = '黑A12345'
AND deleted = 0;
```

**预期结果：**

| id | car_code | owner | reason | park_name | special_car_type_config_name | black_list_forever_flag | created_at |
|----|----------|-------|--------|-----------|------------------------------|-------------------------|------------|
| 50 | 黑A12345 | 张三 | 累计违规3次，系统自动拉黑 | 东北林业大学 | NULL | 永久 | 2025-10-06 14:30:00 |

### 3. 月票配置表（monthly_ticket_timeout_config）

```sql
SELECT 
    park_code,
    timeout_minutes,
    max_violation_count,
    overnight_time_hours
FROM monthly_ticket_timeout_config
WHERE park_code = '2KPL6XFF';
```

**预期结果：**

| park_code | timeout_minutes | max_violation_count | overnight_time_hours |
|-----------|----------------|---------------------|----------------------|
| 2KPL6XFF | 60 | 3 | 4 |

---

## 🐛 常见问题排查

### 问题1：违规记录创建成功，但未触发自动拉黑

**可能原因：**
- 配置的 `maxViolationCount` 未正确读取
- `parkCode` 参数错误

**排查方法：**
1. 检查后端日志，查看是否有 `[自动拉黑检查]` 日志
2. 确认违规次数统计是否正确
3. 检查配置表中的 `max_violation_count` 值

**解决方法：**
```sql
-- 检查配置
SELECT * FROM monthly_ticket_timeout_config WHERE park_code = '2KPL6XFF';

-- 如果没有配置，插入默认配置
INSERT INTO monthly_ticket_timeout_config (park_code, timeout_minutes, max_violation_count, overnight_time_hours)
VALUES ('2KPL6XFF', 60, 3, 4);
```

### 问题2：前端不显示违规次数徽章

**可能原因：**
- `batchGetViolationCounts()` 方法未正确执行
- `row.violationCount` 未正确赋值

**排查方法：**
1. 打开浏览器开发者工具（F12）
2. 查看控制台日志，查找 `[违规次数]` 相关日志
3. 检查网络请求，确认是否有批量查询违规次数的API调用

**解决方法：**
- 刷新页面，重新加载数据
- 检查 `violationApi.getViolations()` 接口是否正常返回

### 问题3：自动拉黑后，违规记录未标记为已处理

**可能原因：**
- `executeAutoBlacklist()` 方法中的批量更新逻辑失败
- 数据库事务回滚

**排查方法：**
1. 检查后端日志，查找 `[批量标记]` 相关日志
2. 确认是否有异常信息

**解决方法：**
```sql
-- 手动修复：将该车牌的未处理违规记录标记为已处理
UPDATE violations
SET process_status = 'processed',
    process_type = 'auto_blacklist',
    processed_by = 'SYSTEM',
    processed_at = NOW(),
    process_remark = '累计违规3次，系统自动拉黑'
WHERE plate_number = '黑A12345'
AND process_status = 'pending';
```

### 问题4：ACMS黑名单接口调用失败

**可能原因：**
- ACMS接口不可用
- 网络问题

**排查方法：**
1. 检查后端日志，查找 `[ACMS拉黑]` 相关日志
2. 确认ACMS接口地址是否正确

**解决方法：**
- 自动拉黑功能设计了容错机制：即使ACMS接口失败，本地黑名单表仍会保存记录
- 违规记录的处理状态不受ACMS接口影响

---

## ✅ 测试通过标准

所有以下条件都满足，视为测试通过：

- ✅ 前3次违规记录正常创建，状态为"未处理"
- ✅ 第3次违规后自动触发拉黑
- ✅ 所有3条违规记录状态变为"已处理"
- ✅ 处理方式为"系统自动拉黑"（`auto_blacklist`）
- ✅ 该车牌出现在黑名单中
- ✅ 前端正确显示违规次数徽章（橙色2次、红色3次）
- ✅ 前端显示自动拉黑警告提示
- ✅ 后端日志记录完整，无异常

---

## 📝 测试记录表

| 测试场景 | 测试时间 | 测试车牌 | 违规次数 | 是否拉黑 | 测试结果 | 备注 |
|---------|---------|---------|---------|---------|---------|------|
| 第1次违规 | 2025-10-06 14:20 | 黑A12345 | 1 | ❌ | ✅ 通过 | 未达阈值 |
| 第2次违规 | 2025-10-06 14:25 | 黑A12345 | 2 | ❌ | ✅ 通过 | 显示警告 |
| 第3次违规 | 2025-10-06 14:30 | 黑A12345 | 3 | ✅ | ✅ 通过 | 自动拉黑 |
| 第4次违规 | 2025-10-06 14:35 | 黑A12345 | 1 | - | ✅ 通过 | 已在黑名单 |

---

## 🎯 下一步

测试通过后，可以：
1. 将 `maxViolationCount` 调整为生产环境的实际值（如5次）
2. 通知相关人员功能已上线
3. 监控生产环境的自动拉黑日志

---

**文档版本：** v1.0  
**最后更新：** 2025-10-06  
**作者：** AI Assistant

