# MyBatis TooManyResultsException 解决方案

## 问题描述
```
org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.TooManyResultsException: Expected one result (or null) to be returned by selectOne(), but found: 8
```

## 问题原因
在 `ViolationsServiceImpl.getOwnerByPlateNumber()` 方法中，使用 `selectOne()` 查询车主信息时，数据库中同一个车牌号对应了多个车主记录，导致返回了 8 个结果而不是期望的 1 个。

## 解决方案

### 方案 1：修改查询逻辑（推荐）

将 `selectOne()` 改为 `selectList()`，然后取第一个结果：

```java
// 原代码（第159行）
Ownerinfo owner = ownerinfoMapper.selectOne(wrapper);

// 修改后的代码
List<Ownerinfo> owners = ownerinfoMapper.selectList(wrapper);
Ownerinfo owner = null;
if (!owners.isEmpty()) {
    // 取第一个结果，或者根据业务逻辑选择最合适的
    owner = owners.get(0);
    
    // 如果有多条记录，记录警告日志
    if (owners.size() > 1) {
        log.warn("车牌号 {} 对应多个车主记录，共 {} 条，使用第一条记录", plateNumber, owners.size());
    }
}
```

### 方案 2：使用 LIMIT 1 限制结果

在查询条件中添加限制，只返回一条记录：

```java
// 使用 MyBatis-Plus 的 last 方法添加 LIMIT 1
QueryWrapper<Ownerinfo> wrapper = new QueryWrapper<>();
wrapper.eq("plate_number", plateNumber)
       .last("LIMIT 1");
Ownerinfo owner = ownerinfoMapper.selectOne(wrapper);
```

### 方案 3：数据去重处理

在查询前先对数据进行去重处理：

```java
// 先查询所有匹配的记录
List<Ownerinfo> owners = ownerinfoMapper.selectList(wrapper);

// 根据业务规则去重（例如：按创建时间排序，取最新的）
if (!owners.isEmpty()) {
    owners.sort((o1, o2) -> o2.getCreatedAt().compareTo(o1.getCreatedAt()));
    owner = owners.get(0);
}
```

## 预防措施

### 1. 数据库层面
- 在 `vehicles` 表的 `plate_number` 字段上添加唯一索引
- 定期清理重复数据

### 2. 应用层面
- 在创建车主/车辆记录时进行重复性检查
- 添加数据验证逻辑

### 3. 监控和日志
- 添加重复数据检测的日志记录
- 设置告警机制，当发现重复数据时及时通知

## 实施步骤

1. **立即修复**：使用方案 1 快速解决当前问题
2. **数据清理**：检查并清理数据库中的重复记录
3. **预防措施**：实施上述预防措施，避免问题再次发生
4. **测试验证**：确保修复后的功能正常工作

## 相关文件
- `ViolationsServiceImpl.java` 第 159 行
- `OwnerinfoMapper.java`
- 数据库表：`owners`、`vehicles` 