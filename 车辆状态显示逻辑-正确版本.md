# 车辆状态显示逻辑 - 正确版本

## 修改时间
2024-12-09

---

## 核心理解

### `venuestatus` 字段的可能值
这是**唯一的状态来源**，包含以下值：
- `"已过期"` - 预约已过期
- `"待入场"` - 等待入场
- `"已入场"` - 已经入场但未离开
- `"已离场"` - 已完成停车并离开

### 时间字段
- **入场时间**：`arrivedate`
- **离场时间**：`leavedate`
- **停车时长**：根据 `arrivedate` 和 `leavedate` 计算

---

## 显示规则

### 规则1：已离场 - 显示详细信息 ✓
当 `venuestatus === "已离场"` 时：

**显示内容**：
```
[✓ 已离场]
入场：2025-12-05 06:29:44
离场：2025-12-07 06:29:44
时长：1天23小时30分钟
```

**样式**：橙色渐变背景，显示完整的停车记录

---

### 规则2：其他状态 - 直接显示 venuestatus
当 `venuestatus` 为其他值时，直接显示该状态：

| venuestatus 值 | 显示文本 | 图标 | 颜色 |
|----------------|----------|------|------|
| "已过期" | × 已过期 | × | 红色 |
| "待入场" | ○ 待入场 | ○ | 灰色 |
| "已入场" | ✓ 已入场 | ✓ | 蓝色 |

---

## 技术实现

### 1. 数据处理
```javascript
// 获取表格数据
const getData = () => {
    request.get(root + "allpage", { params: query })
        .then((res) => {
            tableData.value = res.data.records.map(item => {
                return {
                    ...item,
                    // 只计算停车时长，状态直接使用venuestatus
                    parkingDuration: calculateParkingDuration(item)
                };
            });
        });
};
```

### 2. 停车时长计算
```javascript
const calculateParkingDuration = (item) => {
    const arriveTime = item.arrivedate;
    const leaveTime = item.leavedate;
    
    // 过滤无效值
    if (!arriveTime || !leaveTime || 
        arriveTime === 'null' || arriveTime === '(Null)' ||
        leaveTime === 'null' || leaveTime === '(Null)') {
        return null;
    }
    
    const enter = new Date(arriveTime);
    const leave = new Date(leaveTime);
    
    const diffMs = leave - enter;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    const hours = Math.floor(diffMinutes / 60);
    const minutes = diffMinutes % 60;
    const days = Math.floor(hours / 24);
    const remainingHours = hours % 24;
    
    if (days > 0) {
        return `${days}天${remainingHours}小时${minutes}分钟`;
    } else if (hours > 0) {
        return `${hours}小时${minutes}分钟`;
    } else {
        return `${minutes}分钟`;
    }
};
```

### 3. 辅助函数
```javascript
// 获取状态样式类
const getStatusClass = (venuestatus) => {
    const statusMap = {
        '已过期': 'expired',
        '待入场': 'not-entered',
        '已入场': 'entered',
        '已离场': 'left'
    };
    return statusMap[venuestatus] || 'not-entered';
};

// 获取显示文本
const getStatusText = (venuestatus) => {
    const textMap = {
        '已过期': '× 已过期',
        '待入场': '○ 待入场',
        '已入场': '✓ 已入场',
        '已离场': '✓ 已离场'
    };
    return textMap[venuestatus] || venuestatus;
};

// 获取标签类型（用于详情弹窗）
const getStatusTagType = (venuestatus) => {
    const typeMap = {
        '已过期': 'danger',
        '待入场': 'info',
        '已入场': 'success',
        '已离场': 'warning'
    };
    return typeMap[venuestatus] || 'info';
};
```

### 4. 模板结构
```html
<!-- 车辆状态列 -->
<el-table-column label="车辆状态" width="280">
    <template #default="{ row }">
        <div class="vehicle-parking-cell">
            <!-- 已离场：显示详细信息 -->
            <div v-if="row.venuestatus === '已离场'" class="left-details">
                <div class="status-badge left">✓ 已离场</div>
                <div class="time-details">
                    <div class="time-item">入场：{{ row.arrivedate }}</div>
                    <div class="time-item">离场：{{ row.leavedate }}</div>
                    <div class="time-item duration">时长：{{ row.parkingDuration }}</div>
                </div>
            </div>
            
            <!-- 其他状态：直接显示 -->
            <div v-else class="status-badges">
                <div :class="getStatusClass(row.venuestatus)" class="status-badge">
                    <span class="badge-text">{{ getStatusText(row.venuestatus) }}</span>
                </div>
            </div>
        </div>
    </template>
</el-table-column>
```

---

## 样式配色

| 状态 | CSS类 | 背景渐变 | 文字颜色 |
|------|-------|----------|----------|
| 已过期 | `expired` | #fee2e2 → #fecaca | #991b1b |
| 待入场 | `not-entered` | #f3f4f6 → #e5e7eb | #4b5563 |
| 已入场 | `entered` | #dbeafe → #bfdbfe | #1e40af |
| 已离场 | `left` | #fed7aa → #fdba74 | #92400e |

---

## 显示示例

### 示例1：已离场（有完整记录）
```
┌─────────────────────────────┐
│ [✓ 已离场]                  │
│                             │
│ 入场：2025-12-05 06:29:44   │
│ 离场：2025-12-07 06:29:44   │
│ 时长：2天0小时0分钟          │
└─────────────────────────────┘
```

### 示例2：已入场
```
┌─────────────────┐
│ [✓ 已入场]      │
└─────────────────┘
```

### 示例3：待入场
```
┌─────────────────┐
│ [○ 待入场]      │
└─────────────────┘
```

### 示例4：已过期
```
┌─────────────────┐
│ [× 已过期]      │
└─────────────────┘
```

---

## 关键点总结

### ✅ 正确理解
1. **`venuestatus` 是唯一状态来源**，不需要额外判断
2. **已过期和已入场不会同时出现**，因为 `venuestatus` 只有一个值
3. **时间字段使用 `arrivedate` 和 `leavedate`**，不是 `entertime`/`leavetime`
4. **停车时长通过计算得出**，支持天、小时、分钟的显示

### ❌ 之前的误解
- ~~认为需要同时判断过期状态和入场状态~~
- ~~使用错误的时间字段（entertime/leavetime）~~
- ~~复杂的状态组合逻辑~~

---

## 数据流程

```
后端 venuestatus
    ↓
前端直接使用（不做额外判断）
    ↓
已离场？→ 是 → 显示详细时间信息
    ↓
    否 → 直接显示 venuestatus 对应的徽章
```

---

## 相关文件
- `src/views/admin/Appointment.vue` - 预约管理页面

---

**正确版本完成！** ✅

现在的逻辑完全基于 `venuestatus` 字段，简单明了！
