# è¿è§„ç®¡ç†ç³»ç»Ÿæ•°æ®åº“è®¾è®¡ä¸ŽåŽç«¯æŽ¥å£æ–‡æ¡£

## 1. æ•°æ®åº“è®¾è®¡

### 1.1 è½¦ä¸»ä¿¡æ¯è¡¨ (owners)
```sql
CREATE TABLE owners (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT 'è½¦ä¸»å§“å',
    phone VARCHAR(20) NOT NULL COMMENT 'è”ç³»ç”µè¯',
    address VARCHAR(200) COMMENT 'ä½å€',
    building VARCHAR(20) COMMENT 'æ¥¼æ ‹å·',
    unit VARCHAR(20) COMMENT 'å•å…ƒå·', 
    room VARCHAR(20) COMMENT 'æˆ¿é—´å·',
    id_card VARCHAR(18) COMMENT 'èº«ä»½è¯å·',
    credit_score INT DEFAULT 100 COMMENT 'ä¿¡ç”¨åˆ†',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_phone (phone),
    INDEX idx_name (name)
);
```

### 1.2 è½¦è¾†ä¿¡æ¯è¡¨ (vehicles)
```sql
CREATE TABLE vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plate_number VARCHAR(10) NOT NULL UNIQUE COMMENT 'è½¦ç‰Œå·',
    owner_id BIGINT NOT NULL COMMENT 'è½¦ä¸»ID',
    is_new_energy BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦æ–°èƒ½æºè½¦',
    vehicle_type ENUM('car', 'suv', 'truck', 'motorcycle') DEFAULT 'car' COMMENT 'è½¦è¾†ç±»åž‹',
    brand VARCHAR(50) COMMENT 'å“ç‰Œ',
    model VARCHAR(50) COMMENT 'åž‹å·',
    color VARCHAR(20) COMMENT 'é¢œè‰²',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES owners(id),
    INDEX idx_plate_number (plate_number),
    INDEX idx_owner_id (owner_id)
);
```

### 1.3 è¿è§„è®°å½•è¡¨ (violations)
```sql
CREATE TABLE violations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plate_number VARCHAR(10) NOT NULL COMMENT 'è½¦ç‰Œå·',
    owner_id BIGINT COMMENT 'è½¦ä¸»ID',
    violation_type VARCHAR(50) NOT NULL COMMENT 'è¿è§„ç±»åž‹',
    custom_type VARCHAR(100) COMMENT 'è‡ªå®šä¹‰è¿è§„ç±»åž‹',
    location VARCHAR(200) NOT NULL COMMENT 'è¿è§„ä½ç½®',
    description TEXT COMMENT 'è¿è§„æè¿°',
    appointment_time DATETIME COMMENT 'é¢„çº¦æ—¶é—´',
    enter_time DATETIME COMMENT 'è¿›åœºæ—¶é—´',
    leave_time DATETIME COMMENT 'ç¦»åœºæ—¶é—´',
    status ENUM('pending', 'processing', 'completed', 'cancelled') DEFAULT 'pending' COMMENT 'å¤„ç†çŠ¶æ€',
    severity ENUM('mild', 'moderate', 'severe') DEFAULT 'moderate' COMMENT 'ä¸¥é‡ç¨‹åº¦',
    reporter_id BIGINT COMMENT 'ä¸¾æŠ¥äººID',
    handler_id BIGINT COMMENT 'å¤„ç†äººID',
    photos JSON COMMENT 'çŽ°åœºç…§ç‰‡',
    voice_memo VARCHAR(500) COMMENT 'è¯­éŸ³å¤‡æ³¨æ–‡ä»¶è·¯å¾„',
    remark TEXT COMMENT 'å¤„ç†å¤‡æ³¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES owners(id),
    INDEX idx_plate_number (plate_number),
    INDEX idx_status (status),
    INDEX idx_violation_type (violation_type),
    INDEX idx_created_at (created_at)
);
```

### 1.4 è¿è§„ç±»åž‹é…ç½®è¡¨ (violation_types)
```sql
CREATE TABLE violation_types (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT 'è¿è§„ç±»åž‹åç§°',
    value VARCHAR(50) NOT NULL UNIQUE COMMENT 'è¿è§„ç±»åž‹å€¼',
    icon VARCHAR(10) COMMENT 'å›¾æ ‡',
    category ENUM('common', 'others') DEFAULT 'others' COMMENT 'åˆ†ç±»',
    usage_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    sort_order INT DEFAULT 0 COMMENT 'æŽ’åº',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_usage_count (usage_count)
);
```

### 1.5 åœè½¦è®°å½•è¡¨ (parking_records)
```sql
CREATE TABLE parking_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plate_number VARCHAR(10) NOT NULL COMMENT 'è½¦ç‰Œå·',
    owner_id BIGINT COMMENT 'è½¦ä¸»ID',
    appointment_time DATETIME COMMENT 'é¢„çº¦æ—¶é—´',
    appointment_reason VARCHAR(100) COMMENT 'é¢„çº¦åŽŸå› ',
    enter_time DATETIME COMMENT 'è¿›åœºæ—¶é—´',
    leave_time DATETIME COMMENT 'ç¦»åœºæ—¶é—´',
    parking_duration INT COMMENT 'åœè½¦æ—¶é•¿(åˆ†é’Ÿ)',
    location VARCHAR(200) COMMENT 'åœè½¦ä½ç½®',
    status ENUM('not_entered', 'in_progress', 'completed') DEFAULT 'not_entered' COMMENT 'åœè½¦çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES owners(id),
    INDEX idx_plate_number (plate_number),
    INDEX idx_status (status),
    INDEX idx_appointment_time (appointment_time)
);
```

### 1.6 ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ',
    real_name VARCHAR(50) COMMENT 'çœŸå®žå§“å',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    email VARCHAR(100) COMMENT 'é‚®ç®±',
    role ENUM('owner', 'manager', 'admin') DEFAULT 'owner' COMMENT 'è§’è‰²',
    owner_id BIGINT COMMENT 'å…³è”è½¦ä¸»ID',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
    last_login_at TIMESTAMP COMMENT 'æœ€åŽç™»å½•æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (owner_id) REFERENCES owners(id),
    INDEX idx_username (username),
    INDEX idx_role (role)
);
```

## 2. åŽç«¯æŽ¥å£è®¾è®¡

### 2.1 è½¦ä¸»ä¿¡æ¯ç›¸å…³æŽ¥å£

#### 2.1.1 æ ¹æ®è½¦ç‰Œå·æŸ¥è¯¢è½¦ä¸»ä¿¡æ¯
```
GET /api/owners/by-plate/{plateNumber}
```
**å“åº”ç¤ºä¾‹:**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "id": 1,
        "name": "å¼ ä¸‰",
        "phone": "138****5678",
        "address": "8æ ‹5å•å…ƒ555å®¤",
        "creditScore": 85
    }
}
```

#### 2.1.2 è½¦ç‰Œå·æœç´¢å»ºè®®
```
GET /api/owners/plate-suggestions?keyword={keyword}
```
**å“åº”ç¤ºä¾‹:**
```json
{
    "code": 200,
    "message": "success",
    "data": [
        {
            "plateNumber": "é»‘A12345",
            "ownerName": "å¼ ä¸‰"
        }
    ]
}
```

### 2.2 è¿è§„è®°å½•ç›¸å…³æŽ¥å£

#### 2.2.1 åˆ›å»ºè¿è§„è®°å½•
```
POST /api/violations
```
**è¯·æ±‚ä½“:**
```json
{
    "plateNumber": "é»‘A12345",
    "violationType": "overtime",
    "customType": "",
    "location": "AåŒº-15å·è½¦ä½",
    "description": "è¶…æ—¶åœè½¦2å°æ—¶",
    "photos": ["photo1.jpg", "photo2.jpg"],
    "voiceMemo": "voice.mp3"
}
```

#### 2.2.2 èŽ·å–è¿è§„è®°å½•åˆ—è¡¨
```
GET /api/violations?page=1&size=20&plateNumber=&status=&violationType=
```

#### 2.2.3 æ›´æ–°è¿è§„è®°å½•çŠ¶æ€
```
PUT /api/violations/{id}/status
```
**è¯·æ±‚ä½“:**
```json
{
    "status": "completed",
    "remark": "å·²å¤„ç†å®Œæˆ"
}
```

### 2.3 è¿è§„ç±»åž‹ç›¸å…³æŽ¥å£

#### 2.3.1 èŽ·å–è¿è§„ç±»åž‹åˆ—è¡¨
```
GET /api/violation-types
```
**å“åº”ç¤ºä¾‹:**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "common": [
            {
                "name": "è¶…æ—¶åœè½¦",
                "value": "overtime",
                "icon": "ðŸš—",
                "usage": 45
            }
        ],
        "others": [
            {
                "name": "æœªç»æŽˆæƒåœè½¦",
                "value": "unauthorized",
                "icon": "ðŸ”’",
                "usage": 8
            }
        ]
    }
}
```

### 2.4 ç»Ÿè®¡åˆ†æžç›¸å…³æŽ¥å£

#### 2.4.1 èŽ·å–è¿è§„ç»Ÿè®¡æ•°æ®
```
GET /api/violations/statistics?startDate=2025-01-01&endDate=2025-01-31&plateNumber=
```

#### 2.4.2 èŽ·å–é«˜é£Žé™©è½¦è¾†åˆ—è¡¨
```
GET /api/violations/high-risk-vehicles?startDate=2025-01-01&endDate=2025-01-31
```

### 2.5 è½¦ç‰Œè¯†åˆ«ç›¸å…³æŽ¥å£

#### 2.5.1 è½¦ç‰Œè¯†åˆ«
```
POST /api/plate/recognize
```
**è¯·æ±‚ä½“:**
```json
{
    "image": "base64_encoded_image",
    "multiDetect": false
}
```
**å“åº”ç¤ºä¾‹:**
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "success": true,
        "plateNumber": "é»‘A12345",
        "color": "è“ç‰Œ",
        "confidence": 95
    }
}
```

## 3. æ•°æ®åˆå§‹åŒ–è„šæœ¬

### 3.1 è½¦ä¸»æ•°æ®
```sql
INSERT INTO owners (name, phone, address, building, unit, room, credit_score) VALUES
('å¼ ä¸‰', '13812345678', '8æ ‹5å•å…ƒ555å®¤', '8', '5', '555', 85),
('æŽå››', '13912345678', '5æ ‹1å•å…ƒ105å®¤', '5', '1', '105', 92),
('çŽ‹äº”', '13712345678', '2æ ‹7å•å…ƒ105å®¤', '2', '7', '105', 78);
```

### 3.2 è½¦è¾†æ•°æ®
```sql
INSERT INTO vehicles (plate_number, owner_id, is_new_energy) VALUES
('é»‘A12345', 1, FALSE),
('é»‘B67890', 2, FALSE),
('é»‘AF57913', 3, TRUE);
```

### 3.3 è¿è§„ç±»åž‹æ•°æ®
```sql
INSERT INTO violation_types (name, value, icon, category, usage_count, sort_order) VALUES
('è¶…æ—¶åœè½¦', 'overtime', 'ðŸš—', 'common', 45, 1),
('æœªæŒ‰ä½åœè½¦', 'wrong_position', 'ðŸ…¿ï¸', 'common', 30, 2),
('å ç”¨ä»–äººè½¦ä½', 'occupy_space', 'ðŸš«', 'common', 15, 3),
('é®æŒ¡è½¦ç‰Œ', 'block_plate', 'ðŸš«', 'common', 12, 4),
('æœªç»æŽˆæƒåœè½¦', 'unauthorized', 'ðŸ”’', 'others', 8, 5),
('å µå¡žé€šé“', 'block_passage', 'ðŸš§', 'others', 6, 6),
('å ç”¨æ®‹ç–¾äººè½¦ä½', 'disabled_space', 'â™¿', 'others', 4, 7),
('é€†å‘åœè½¦', 'reverse_parking', 'ðŸ”„', 'others', 3, 8),
('è·¨çº¿åœè½¦', 'cross_line', 'ðŸ“', 'others', 3, 9),
('å ç”¨æ¶ˆé˜²é€šé“', 'fire_lane', 'ðŸš’', 'others', 2, 10),
('å ç”¨å……ç”µæ¡©è½¦ä½', 'charging_space', 'ðŸ”Œ', 'others', 2, 11),
('è½¦è¾†æŸå', 'vehicle_damage', 'ðŸ”§', 'others', 1, 12),
('å…¶ä»–', 'other', 'âž•', 'others', 1, 13);
```

## 4. ä¸šåŠ¡é€»è¾‘è¯´æ˜Ž

### 4.1 ä¿¡ç”¨åˆ†è®¡ç®—è§„åˆ™
- åˆå§‹ä¿¡ç”¨åˆ†ï¼š100åˆ†
- è½»å¾®è¿è§„ï¼š-2åˆ†ï¼ˆå¦‚æœªæŒ‰ä½åœè½¦ï¼‰
- ä¸­ç­‰è¿è§„ï¼š-5åˆ†ï¼ˆå¦‚è¶…æ—¶åœè½¦ï¼‰
- ä¸¥é‡è¿è§„ï¼š-10åˆ†ï¼ˆå¦‚å ç”¨æ®‹ç–¾äººè½¦ä½ï¼‰
- ä¿¡ç”¨åˆ†ç­‰çº§ï¼š
  - 80-100åˆ†ï¼šä¼˜ç§€ï¼ˆç»¿è‰²ï¼‰
  - 60-79åˆ†ï¼šé¢„è­¦ï¼ˆæ©™è‰²ï¼‰
  - 0-59åˆ†ï¼šè­¦å‘Šï¼ˆçº¢è‰²ï¼‰

### 4.2 è¿è§„å¤„ç†æµç¨‹
1. **å¾…å¤„ç†(pending)**: æ–°åˆ›å»ºçš„è¿è§„è®°å½•
2. **å¤„ç†ä¸­(processing)**: ç®¡å®¶æ­£åœ¨å¤„ç†
3. **å·²å®Œæˆ(completed)**: å¤„ç†å®Œæˆ
4. **å·²å–æ¶ˆ(cancelled)**: å–æ¶ˆå¤„ç†

### 4.3 åœè½¦çŠ¶æ€è¯´æ˜Ž
- **æœªè¿›åœº(not_entered)**: æœ‰é¢„çº¦ä½†æœªè¿›åœº
- **åœ¨åœºä¸­(in_progress)**: å·²è¿›åœºä½†æœªç¦»åœº
- **å·²ç¦»åœº(completed)**: å·²å®Œæˆåœè½¦

## 5. APIé”™è¯¯ç å®šä¹‰

```json
{
    "200": "æˆåŠŸ",
    "400": "è¯·æ±‚å‚æ•°é”™è¯¯",
    "401": "æœªæŽˆæƒ",
    "403": "æƒé™ä¸è¶³",
    "404": "èµ„æºä¸å­˜åœ¨",
    "500": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
    "1001": "è½¦ç‰Œå·æ ¼å¼é”™è¯¯",
    "1002": "è½¦ä¸»ä¿¡æ¯ä¸å­˜åœ¨",
    "1003": "è¿è§„ç±»åž‹ä¸å­˜åœ¨",
    "1004": "è½¦ç‰Œè¯†åˆ«å¤±è´¥",
    "1005": "å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ"
}
```

## 6. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å»ºè®®

### 6.1 å¤åˆç´¢å¼•
```sql
-- è¿è§„è®°å½•æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_violations_plate_status_time ON violations(plate_number, status, created_at);
CREATE INDEX idx_violations_type_time ON violations(violation_type, created_at);

-- åœè½¦è®°å½•æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_parking_plate_status_time ON parking_records(plate_number, status, appointment_time);
```

### 6.2 åˆ†åŒºè¡¨å»ºè®®
```sql
-- æŒ‰æœˆåˆ†åŒºè¿è§„è®°å½•è¡¨ï¼ˆé€‚ç”¨äºŽå¤§æ•°æ®é‡ï¼‰
ALTER TABLE violations PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    -- ... æ›´å¤šåˆ†åŒº
);
```

## 7. ç¼“å­˜ç­–ç•¥

### 7.1 Redisç¼“å­˜è®¾è®¡
```
# è½¦ä¸»ä¿¡æ¯ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
owner:plate:{plateNumber} -> owner_info_json

# è¿è§„ç±»åž‹ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
violation:types -> violation_types_json

# ç»Ÿè®¡æ•°æ®ç¼“å­˜ï¼ˆ10åˆ†é’Ÿï¼‰
stats:violations:{date_range} -> statistics_json

# è½¦ç‰Œæœç´¢å»ºè®®ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
suggestions:plate:{keyword} -> suggestions_json
```

### 7.2 ç¼“å­˜æ›´æ–°ç­–ç•¥
- è½¦ä¸»ä¿¡æ¯ï¼šå†™å…¥æ—¶æ›´æ–°ç¼“å­˜
- è¿è§„ç±»åž‹ï¼šå®šæ—¶åˆ·æ–° + æ‰‹åŠ¨æ¸…é™¤
- ç»Ÿè®¡æ•°æ®ï¼šå®šæ—¶è®¡ç®— + å®žæ—¶æ›´æ–°
- æœç´¢å»ºè®®ï¼šLRUæ·˜æ±°ç­–ç•¥

## 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 æ•°æ®åº“ä¼˜åŒ–
1. ä½¿ç”¨è¯»å†™åˆ†ç¦»ï¼Œç»Ÿè®¡æŸ¥è¯¢èµ°ä»Žåº“
2. å¯¹åŽ†å²æ•°æ®è¿›è¡Œå½’æ¡£ï¼Œä¿æŒä¸»è¡¨æ•°æ®é‡é€‚ä¸­
3. ä½¿ç”¨è¿žæŽ¥æ± ï¼Œé¿å…é¢‘ç¹å»ºç«‹è¿žæŽ¥
4. å®šæœŸåˆ†æžæ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–SQLè¯­å¥

### 8.2 æŽ¥å£ä¼˜åŒ–
1. åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§è¿”å›žå¤§é‡æ•°æ®
2. ä½¿ç”¨å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œï¼ˆå¦‚å›¾ç‰‡ä¸Šä¼ ï¼‰
3. å®žçŽ°æŽ¥å£é™æµï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚
4. ä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡è®¿é—®

## 9. å®‰å…¨è€ƒè™‘

### 9.1 æ•°æ®å®‰å…¨
1. æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼ˆå¦‚èº«ä»½è¯å·ï¼‰
2. æ‰‹æœºå·è„±æ•æ˜¾ç¤º
3. å›¾ç‰‡æ–‡ä»¶å®‰å…¨æ£€æŸ¥
4. SQLæ³¨å…¥é˜²æŠ¤

### 9.2 æŽ¥å£å®‰å…¨
1. JWT tokenè®¤è¯
2. æŽ¥å£æƒé™æŽ§åˆ¶
3. è¯·æ±‚å‚æ•°æ ¡éªŒ
4. é˜²é‡æ”¾æ”»å‡»

## 10. ç›‘æŽ§å‘Šè­¦

### 10.1 ä¸šåŠ¡ç›‘æŽ§
- è¿è§„è®°å½•åˆ›å»ºæˆåŠŸçŽ‡
- è½¦ç‰Œè¯†åˆ«å‡†ç¡®çŽ‡
- æŽ¥å£å“åº”æ—¶é—´
- æ•°æ®åº“è¿žæŽ¥æ± çŠ¶æ€

### 10.2 å‘Šè­¦è§„åˆ™
- æŽ¥å£é”™è¯¯çŽ‡ > 5%
- å“åº”æ—¶é—´ > 2ç§’
- æ•°æ®åº“è¿žæŽ¥æ•° > 80%
- ç£ç›˜ä½¿ç”¨çŽ‡ > 85%
```
