# 🕐 停车超时推送时间段 - 前端配置功能说明

## 📌 功能概述

在前端管理界面中添加了**超时推送时间段配置**功能，管理员可以通过可视化界面设置每天发送超时推送消息的时间范围。

---

## 🎨 界面位置

**页面路径**：违规管理 → 月票车配置（欧洲新城）

**打开方式**：
1. 进入违规管理页面
2. 点击顶部按钮 "月票车配置（欧洲新城）"
3. 在配置弹窗中找到"超时推送时间段配置"section

---

## ✨ 新增配置项

### 1. 推送开始时间
- **字段名**：notificationStartTime
- **类型**：时间选择器（el-time-select）
- **默认值**：23:00（晚上11点）
- **说明**：设置每天开始发送超时推送的时间

### 2. 推送结束时间
- **字段名**：notificationEndTime
- **类型**：时间选择器（el-time-select）
- **默认值**：06:00（早上6点）
- **说明**：设置每天停止发送超时推送的时间
- **支持跨日**：如23:00-06:00表示晚上11点到次日早上6点

---

## 🔧 修改内容

### 1️⃣ 数据模型修改

**文件**：`src/views/admin/IllegalRegiste.vue`

#### configForm 添加新字段
```javascript
const configForm = reactive({
    parkCode: "2KPL6XFF",
    timeoutMinutes: 60,
    maxViolationCount: 5,
    overnightTimeHours: 4,
    exemptTicketTypes: '',
    // 🆕 推送时间段配置
    notificationStartTime: "23:00",  // 推送开始时间
    notificationEndTime: "06:00"     // 推送结束时间
});
```

---

### 2️⃣ 界面元素添加

在"过夜停车规则配置"之后，"月票类型免检配置"之前，添加了新的配置section：

```vue
<el-divider content-position="left">
    <span style="color: #10b981; font-weight: bold;">🕐 超时推送时间段配置</span>
</el-divider>

<el-form-item label="推送开始时间" prop="notificationStartTime">
    <el-time-select
        v-model="configForm.notificationStartTime"
        start="00:00"
        step="00:30"
        end="23:30"
        placeholder="选择推送开始时间"
        style="width: 100%;"
    />
    <div class="form-tip">
        🕐 设置每天开始发送超时推送的时间（建议：23:00）
    </div>
</el-form-item>

<el-form-item label="推送结束时间" prop="notificationEndTime">
    <el-time-select
        v-model="configForm.notificationEndTime"
        start="00:00"
        step="00:30"
        end="23:30"
        placeholder="选择推送结束时间"
        style="width: 100%;"
    />
    <div class="form-tip">
        🕐 设置每天停止发送超时推送的时间（建议：06:00）。支持跨日设置，如23:00-06:00表示晚上11点到早上6点
    </div>
</el-form-item>
```

---

### 3️⃣ 配置加载逻辑

在 `handleMonthlyTicketConfig` 方法中添加了从后端读取推送时间段的逻辑：

```javascript
// 🕐 解析推送时间段配置（从description字段中的JSON）
if (config.description) {
    try {
        const descConfig = JSON.parse(config.description);
        configForm.notificationStartTime = descConfig.notificationStartTime || "23:00";
        configForm.notificationEndTime = descConfig.notificationEndTime || "06:00";
        console.log('加载推送时间段配置:', configForm.notificationStartTime, '~', configForm.notificationEndTime);
    } catch (e) {
        console.warn('解析description配置失败:', e);
        configForm.notificationStartTime = "23:00";
        configForm.notificationEndTime = "06:00";
    }
} else {
    configForm.notificationStartTime = "23:00";
    configForm.notificationEndTime = "06:00";
}
```

---

### 4️⃣ 配置保存逻辑

在 `handleSaveConfig` 方法中添加了将推送时间段保存到 `description` 字段的逻辑：

```javascript
// 🕐 构建description JSON（包含推送时间段配置）
const descriptionConfig = {
    notificationStartTime: configForm.notificationStartTime || "23:00",
    notificationEndTime: configForm.notificationEndTime || "06:00"
};
const description = JSON.stringify(descriptionConfig);

// 调用保存接口（包含过夜停车配置、免检类型和推送时间段）
const response = await violationApi.saveMonthlyTicketFullConfig({
    parkCode: configForm.parkCode,
    timeoutMinutes: configForm.timeoutMinutes,
    maxViolationCount: configForm.maxViolationCount,
    overnightTimeHours: configForm.overnightTimeHours,
    enableOvernightCheck: true,
    exemptTicketTypes: exemptTypes,
    description: description  // 🆕 添加推送时间段配置
});
```

---

### 5️⃣ 操作日志增强

在操作日志中添加了推送时间段信息：

```javascript
const notificationDesc = `，推送时间段：${configForm.notificationStartTime}~${configForm.notificationEndTime}`;

await activityApi.logViolationOperation(
    userId,
    username,
    "配置",
    `设置月票车超时配置：超时时间${configForm.timeoutMinutes}分钟，累计次数${configForm.maxViolationCount}次，过夜时长${configForm.overnightTimeHours}小时${exemptTypesDesc}${notificationDesc}`,
    null,
    JSON.stringify(configForm),
    null
);
```

---

## 📊 数据流程

### 保存配置流程

```
用户选择时间
    ↓
构建 JSON: { 
    "notificationStartTime": "23:00", 
    "notificationEndTime": "06:00" 
}
    ↓
转换为字符串
    ↓
作为 description 字段保存到数据库
    ↓
后端定时任务读取并应用
```

### 加载配置流程

```
打开配置弹窗
    ↓
从后端API获取配置
    ↓
解析 description 字段的 JSON
    ↓
提取 notificationStartTime 和 notificationEndTime
    ↓
填充到表单
```

---

## 🎯 使用方法

### 步骤1：打开配置弹窗
1. 登录管理后台
2. 进入"违规管理"页面
3. 点击"月票车配置（欧洲新城）"按钮

### 步骤2：设置推送时间段
1. 找到"超时推送时间段配置"section
2. 选择"推送开始时间"（如：23:00）
3. 选择"推送结束时间"（如：06:00）

### 步骤3：保存配置
1. 检查其他配置项
2. 点击"保存配置"按钮
3. 等待成功提示

---

## ⏰ 推送时间段示例

### 示例1：晚上11点到早上6点（默认）
- 推送开始时间：23:00
- 推送结束时间：06:00
- **效果**：每天23:00-次日06:00发送推送

### 示例2：晚上10点到早上7点
- 推送开始时间：22:00
- 推送结束时间：07:00
- **效果**：每天22:00-次日07:00发送推送

### 示例3：全天推送
- 推送开始时间：00:00
- 推送结束时间：23:30
- **效果**：24小时全天发送推送

### 示例4：仅白天推送
- 推送开始时间：08:00
- 推送结束时间：18:00
- **效果**：每天08:00-18:00发送推送

---

## 🔍 验证方式

### 1. 查看保存的配置

在浏览器控制台查看：
```javascript
// 打开配置弹窗时，控制台会输出：
加载推送时间段配置: 23:00 ~ 06:00
```

### 2. 查看数据库

```sql
SELECT park_code, park_name, description, is_active
FROM monthly_ticket_timeout_config
WHERE park_code = '2KPL6XFF';
```

**期望结果**：
```json
{
  "notificationStartTime": "23:00",
  "notificationEndTime": "06:00"
}
```

### 3. 查看操作日志

在"活动日志"页面查看配置操作记录，应包含推送时间段信息：
```
设置月票车超时配置：超时时间120分钟，累计次数5次，过夜时长4小时，无免检类型，推送时间段：23:00~06:00
```

---

## ⚠️ 注意事项

1. **时间格式**：必须使用 HH:mm 格式（如 23:00）
2. **跨日支持**：支持跨日时间段（如 23:00-06:00）
3. **立即生效**：保存后立即生效，后端定时任务会在下次执行时读取新配置
4. **默认值**：如果未配置，系统使用默认值 23:00-06:00
5. **车场限制**：目前只针对"欧洲新城"车场（park_code: 2KPL6XFF）

---

## 🔗 相关文件

| 文件路径 | 说明 |
|---------|------|
| `src/views/admin/IllegalRegiste.vue` | 前端配置页面 |
| `ParkingTimeoutMonitoringTask.java` | 后端定时任务（读取配置） |
| `monthly_ticket_timeout_config` | 数据库配置表 |

---

## 📋 后续优化建议

1. **多车场支持**：扩展到其他车场（万象上东、东北林业大学等）
2. **预设模板**：提供常用时间段快捷选择
3. **可视化提示**：显示当前时间是否在推送时间段内
4. **推送统计**：显示各时间段的推送次数统计
5. **批量配置**：支持为多个车场批量设置相同的推送时间段

---

## ✅ 完成情况

- ✅ 前端UI界面添加完成
- ✅ 数据模型定义完成
- ✅ 配置加载逻辑完成
- ✅ 配置保存逻辑完成
- ✅ 操作日志记录完成
- ✅ 文档编写完成

配置功能已经可以正常使用，管理员可以通过界面灵活设置推送时间段！
