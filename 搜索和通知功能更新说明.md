# 搜索和通知功能更新说明

## 更新日期
2025年10月31日

## 更新内容

### 1. 搜索框功能优化 ✅

#### 变更说明
- **移除**：功能模块搜索（如"业主管理"、"小区管理"等菜单项搜索）
- **保留**：车牌号搜索和业主姓名搜索
- **优化**：搜索提示文字从"搜索功能、业主、车牌..."改为"搜索车牌号、业主姓名..."

#### 功能特性
1. **车牌号搜索**
   - 输入2个及以上字符自动触发搜索
   - 优先从违规记录中获取车牌建议
   - 如果违规记录API失败，自动降级到业主API
   - 显示车牌号、车主姓名、电话、违规次数等信息
   - 去重显示，避免重复车牌

2. **业主姓名搜索**
   - 输入2个及以上字符自动触发搜索
   - 不限制中文输入（之前只支持中文，现在支持任意字符）
   - 显示业主姓名和电话号码
   - 去重显示，避免重复业主
   - 添加详细日志便于调试

3. **搜索结果跳转**
   - 所有搜索结果都跳转到违规查询页面 (`/admin/IllegalRegiste`)
   - 自动填充搜索条件（车牌号、业主姓名、电话等）
   - 回车键可快速搜索

#### 技术细节
```javascript
// 车牌搜索示例
{
  title: `车牌: 京A12345`,
  type: '车牌号码',
  icon: 'CreditCard',
  path: '/admin/IllegalRegiste',
  plateNumber: '京A12345',
  ownerName: '张三',
  ownerPhone: '13800138000',
  violationCount: 3,
  isPlateSearch: true
}

// 业主搜索示例
{
  title: `业主: 张三 (13800138000)`,
  type: '业主信息',
  icon: 'User',
  path: '/admin/IllegalRegiste',
  ownerName: '张三',
  ownerPhone: '13800138000',
  plateNumber: '京A12345',
  isOwnerSearch: true
}
```

---

### 2. 通知系统优化 ✅

#### 变更说明
- **优化**：点击通知铃铛后，所有当前通知标记为已查看
- **持久化**：已查看的通知ID保存到 localStorage
- **刷新保护**：页面刷新后，已查看的通知不再显示

#### 功能特性
1. **点击铃铛行为**
   - 点击通知铃铛时，自动标记所有当前通知为已查看
   - 清空通知列表显示
   - 通知计数归零
   - 已查看记录保存到 localStorage

2. **删除通知行为**
   - 单个删除通知时，标记该通知为已查看
   - 清空所有通知时，标记所有通知为已查看
   - 所有操作都会更新 localStorage

3. **刷新后行为**
   - 页面刷新后自动加载已查看通知ID列表
   - 过滤掉已查看的通知
   - 只显示新的、未查看的通知
   - 保持用户体验的连续性

4. **数据管理**
   - 只保留最近1000个已查看通知ID，避免 localStorage 过大
   - 自动清理超出限制的旧记录
   - 通知仍然只显示最近4小时内的活动

#### 技术细节
```javascript
// localStorage 结构
{
  "viewedNotificationIds": [123, 456, 789, ...]
}

// 已查看通知管理函数
getViewedNotificationIds()      // 获取已查看的通知ID列表
saveViewedNotificationIds(ids)  // 保存已查看的通知ID列表
markNotificationsAsViewed(ids)  // 标记通知为已查看
```

---

### 3. 用户角色显示 ✅

#### 变更说明
- **动态获取**：右上角用户角色名称从动态API获取
- **智能降级**：如果API失败，使用默认值"系统管理员"

#### 功能特性
1. **用户信息加载**
   - 页面加载时自动获取当前用户信息
   - 解析用户角色名称（支持单角色和多角色）
   - 如果有多个角色，显示第一个角色

2. **显示逻辑**
   - 优先使用 `userData.roleName`
   - 如果没有，使用 `userData.roles[0].roleName`
   - 最后降级到默认值"系统管理员"

---

### 4. 通知过滤优化 ✅

#### 变更说明
- **用户过滤**：通知只显示当前登录用户的操作日志
- **时间过滤**：只显示最近4小时内的活动
- **已查看过滤**：过滤掉已查看的通知

---

## API依赖

### 新增API
```javascript
// owner.js
ownerApi.getOwnerNameSuggestions(keyword)  // 业主姓名搜索建议

// user.js
userApi.getCurrentUser()  // 获取当前用户信息

// activity.js
activityApi.getActivityLogPage(params)  // 分页查询活动日志（带用户ID过滤）
```

### 已有API
```javascript
violationApi.getViolationPlateSuggestions(queryString)  // 车牌搜索建议
ownerApi.getPlateSuggestions(queryString)               // 车牌搜索建议（降级）
```

---

## 使用示例

### 搜索功能
1. 输入车牌号"京A"：显示所有以"京A"开头的车牌建议
2. 输入业主姓名"张三"：显示所有姓名包含"张三"的业主建议
3. 选择搜索结果：自动跳转到违规查询页面并填充搜索条件
4. 按回车键：直接跳转到违规查询页面，使用输入内容作为关键词

### 通知功能
1. 点击铃铛图标：打开通知面板，所有通知自动标记为已查看
2. 刷新页面：已查看的通知不再显示
3. 删除通知：单个通知标记为已查看
4. 清空全部：所有通知标记为已查看

---

## 调试技巧

### 查看搜索日志
打开浏览器控制台，搜索时会输出：
```
Header: 业主姓名搜索响应: {...}
Header: 业主姓名搜索结果: [...]
Header: 搜索结果汇总: [...]
```

### 查看通知日志
```
Header: 当前用户信息加载成功 {userId: 1, role: "系统管理员"}
Header: 用户点击通知铃铛
Header: 已标记所有通知为已查看
```

### 清空已查看记录
在浏览器控制台执行：
```javascript
localStorage.removeItem('viewedNotificationIds');
```

---

## 注意事项

1. **搜索功能**
   - 确保后端实现了 `getOwnerNameSuggestions` API
   - 确保违规查询页面支持接收 `plateNumber`、`ownerName`、`ownerPhone` 等查询参数

2. **通知功能**
   - localStorage 有容量限制（约5-10MB），但1000个ID足够使用
   - 如果需要跨设备同步已查看状态，需要改为后端存储

3. **用户角色**
   - 确保后端 `/parking/user/current` API 返回角色信息
   - 支持的字段：`roleName`、`roles[].roleName`、`roles[].name`

---

## 文件变更清单

### 修改的文件
- `src/components/Header.vue` - 主要逻辑修改
- `src/api/owner.js` - 添加业主姓名搜索API

### 未修改的文件
- `src/api/user.js` - 已有getCurrentUser方法，无需修改
- `src/api/activity.js` - 已有getActivityLogPage方法，无需修改
- `src/api/violation.js` - 已有getViolationPlateSuggestions方法，无需修改

---

## 测试建议

### 搜索功能测试
1. ✅ 测试车牌号搜索（如：京A、京A12345）
2. ✅ 测试业主姓名搜索（如：张三、李四）
3. ✅ 测试空输入（应该不显示任何建议）
4. ✅ 测试搜索结果跳转
5. ✅ 测试回车键搜索

### 通知功能测试
1. ✅ 测试点击铃铛标记为已查看
2. ✅ 测试刷新页面后不显示已查看通知
3. ✅ 测试删除单个通知
4. ✅ 测试清空所有通知
5. ✅ 测试新通知到达时的显示

### 用户角色测试
1. ✅ 测试不同角色用户登录后的显示
2. ✅ 测试API失败时的降级处理

---

## 版本信息
- 版本：v1.1.0
- 更新日期：2025-10-31
- 开发者：AI Assistant

