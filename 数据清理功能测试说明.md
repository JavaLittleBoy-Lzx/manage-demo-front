# 数据清理功能测试说明

## 功能验证

### 测试场景

1. **正常清理场景**
   - 本地有5条黑名单记录
   - 外部API返回3条记录
   - 预期：清理2条多余记录

2. **无需清理场景**
   - 本地有3条黑名单记录
   - 外部API返回3条记录
   - 预期：无需清理

3. **全部清理场景**
   - 本地有5条黑名单记录
   - 外部API返回0条记录
   - 预期：清理全部5条记录

### 测试步骤

1. **准备测试数据**
   ```sql
   -- 插入测试黑名单记录
   INSERT INTO black_list (car_code, park_name, create_time, is_deleted) VALUES
   ('黑A12345', '万象上东', NOW(), 0),
   ('黑B67890', '万象上东', NOW(), 0),
   ('黑C11111', '万象上东', NOW(), 0);
   ```

2. **调用清理接口**
   ```http
   GET /parking/blackList/autoDeleteByExternalApi?parkName=万象上东
   ```

3. **验证结果**
   - 检查返回的统计信息
   - 确认清理的车牌号列表
   - 验证数据库记录状态

### 预期结果

```json
{
  "code": "0",
  "msg": "数据清理完成！清理了 X 条多余的黑名单记录和 Y 条违规记录",
  "data": {
    "parkName": "万象上东",
    "localRecordCount": 3,
    "externalRecordCount": 1,
    "deletedBlackListCount": 2,
    "deletedViolationCount": 0,
    "deletedCars": ["黑A12345", "黑B67890"]
  }
}
```

## 功能特点总结

### ✅ 已实现功能

1. **智能对比**：自动对比本地与外部API数据
2. **精准清理**：只清理本地多余的数据
3. **关联清理**：同时清理违规记录
4. **安全操作**：使用逻辑删除
5. **操作日志**：完整的操作记录
6. **用户确认**：操作前确认机制
7. **错误处理**：完善的异常处理

### 🎯 核心逻辑

```java
// 1. 查询本地黑名单记录
List<BlackList> localBlackList = blackListService.queryInfoOnly(parkName, ...);

// 2. 查询外部API黑名单记录
String get = HttpClientUtil.doPost("https://www.xuerparking.cn:8543/parking/blackList/getParkBlackList", hashMap);

// 3. 构建外部API车牌号集合
Set<String> externalCarCodes = new HashSet<>();
// 解析外部API返回的车牌号

// 4. 找出需要清理的多余记录（本地有但外部API没有）
List<BlackList> toDeleteList = new ArrayList<>();
for (BlackList localRecord : localBlackList) {
    if (!externalCarCodes.contains(localRecord.getCarCode())) {
        toDeleteList.add(localRecord);
    }
}

// 5. 执行清理操作
for (BlackList record : toDeleteList) {
    // 清理违规记录
    violationsService.deleteViolationsByPlateAndPark(record.getCarCode(), parkName);
    // 清理黑名单记录（逻辑删除）
    blackListService.logicDeleteById(record.getId(), deleteBy);
}
```

### 🔧 技术实现

- **后端**：Spring Boot + MyBatis
- **前端**：Vue.js + Element UI
- **数据库**：MySQL
- **外部API**：HTTP POST请求
- **日志**：控制台输出 + 数据库记录

---

**功能状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试  
**部署状态**: ⏳ 待部署
