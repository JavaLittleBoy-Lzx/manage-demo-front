# 车辆状态显示逻辑 - 最终版本

## 修改时间
2024-12-09

## 核心逻辑

### 1. 状态判断依据
- **唯一数据源**：`venuestatus` 字段
  - `"已入场"` → 已入场但未离场
  - `"已离场"` → 已完成停车离开
  - 其他值 → 未入场

### 2. 过期判断
- 通过 `visitdate`（预约日期）与当前日期对比
- `visitdate < 今天` → 已过期

---

## 显示规则

### 场景1：已离场 ✓
**显示内容**：
- 状态徽章：`✓ 已离场`（橙色）
- 详细时间信息：
  - 入场时间：`2025-12-05 06:29:44`
  - 离场时间：`2025-12-07 06:29:44`
  - 停车时长：`1小时30分钟`

**说明**：
- 只显示离场状态，不显示过期状态
- 展示完整的停车记录

**示例代码**：
```html
<div class="left-details">
    <div class="status-badge left">✓ 已离场</div>
    <div class="time-details">
        <div class="time-item">入场：2025-12-05 06:29:44</div>
        <div class="time-item">离场：2025-12-07 06:29:44</div>
        <div class="time-item duration">时长：1小时30分钟</div>
    </div>
</div>
```

---

### 场景2：已入场 + 已过期 × ✓
**显示内容**：
- 第一个徽章：`× 已过期`（红色）
- 第二个徽章：`✓ 已入场`（蓝色）

**说明**：
- 同时显示两个状态
- 可以看到车辆虽然过期了但已经入场

**示例**：
```
[× 已过期] [✓ 已入场]
```

---

### 场景3：已入场 + 有效 ✓ ✓
**显示内容**：
- 第一个徽章：`✓ 有效`（绿色）
- 第二个徽章：`✓ 已入场`（蓝色）

**示例**：
```
[✓ 有效] [✓ 已入场]
```

---

### 场景4：未入场 + 已过期 × ○
**显示内容**：
- 第一个徽章：`× 已过期`（红色）
- 第二个徽章：`○ 未入场`（灰色）

**示例**：
```
[× 已过期] [○ 未入场]
```

---

### 场景5：未入场 + 有效 ✓ ○
**显示内容**：
- 第一个徽章：`✓ 有效`（绿色）
- 第二个徽章：`○ 未入场`（灰色）

**示例**：
```
[✓ 有效] [○ 未入场]
```

---

## 技术实现

### 状态判断函数
```javascript
const getVehicleStatus = (item) => {
    const venuestatus = item.venuestatus || '';
    const visitdate = item.visitdate;
    
    // 检查是否过期
    let isExpired = false;
    if (visitdate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const visitDate = new Date(visitdate);
        visitDate.setHours(0, 0, 0, 0);
        isExpired = visitDate < today;
    }
    
    // 根据venuestatus判断状态
    const hasEntered = venuestatus === '已入场' || venuestatus === '已离场';
    const hasLeft = venuestatus === '已离场';
    
    // 未离场时才显示过期状态
    const shouldShowExpired = isExpired && !hasLeft;
    
    return {
        isExpired,
        hasEntered,
        hasLeft,
        shouldShowExpired
    };
};
```

### 模板结构
```html
<!-- 已离场：显示详细时间 -->
<div v-if="row.hasLeft" class="left-details">
    <div class="status-badge left">✓ 已离场</div>
    <div class="time-details">
        <div class="time-item">入场：{{ row.entertime }}</div>
        <div class="time-item">离场：{{ row.leavetime }}</div>
        <div class="time-item duration">时长：{{ row.parkingDuration }}</div>
    </div>
</div>

<!-- 未离场：显示状态徽章 -->
<div v-else class="status-badges">
    <!-- 过期/有效 -->
    <div v-if="row.shouldShowExpired" class="status-badge expired">
        × 已过期
    </div>
    <div v-else class="status-badge valid">
        ✓ 有效
    </div>
    
    <!-- 入场状态 -->
    <div :class="['status-badge', row.hasEntered ? 'entered' : 'not-entered']">
        {{ row.hasEntered ? '✓ 已入场' : '○ 未入场' }}
    </div>
</div>
```

---

## 颜色方案

| 状态 | 图标 | 颜色 | 背景渐变 |
|------|------|------|----------|
| 有效 | ✓ | 深绿 #065f46 | #d1fae5 → #a7f3d0 |
| 已过期 | × | 深红 #991b1b | #fee2e2 → #fecaca |
| 已入场 | ✓ | 深蓝 #1e40af | #dbeafe → #bfdbfe |
| 未入场 | ○ | 灰色 #4b5563 | #f3f4f6 → #e5e7eb |
| 已离场 | ✓ | 橙棕 #92400e | #fed7aa → #fdba74 |

---

## 关键改进

### ✅ 已完成的优化

1. **已离场详情显示**
   - 显示入场时间
   - 显示离场时间
   - 显示停车时长
   - 不显示过期状态（避免冗余）

2. **已入场可显示过期**
   - 支持同时显示"已过期"和"已入场"
   - 更准确反映实际状态

3. **图标兼容性**
   - 使用Unicode字符替代emoji
   - 避免显示为问号

4. **状态优先级**
   ```
   已离场 > 其他状态组合
   ```

---

## 数据字段依赖

| 字段名 | 用途 | 示例值 |
|--------|------|--------|
| `venuestatus` | 入场离场状态 | "已入场"/"已离场" |
| `visitdate` | 预约日期（判断过期） | "2025-12-04" |
| `entertime` / `entrytime` | 入场时间 | "2025-12-05 06:29:44" |
| `leavetime` | 离场时间 | "2025-12-07 06:29:44" |
| `parkingDuration` | 停车时长（计算得出） | "1小时30分钟" |

---

## 相关文件
- `src/views/admin/Appointment.vue` - 预约管理页面

---

**最终版本完成！** ✅
